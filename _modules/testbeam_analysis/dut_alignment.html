

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>testbeam_analysis.dut_alignment &mdash; Testbeam Analysis 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/silab.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Testbeam Analysis 0.0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Testbeam Analysis
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBA.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Testbeam Analysis</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>testbeam_analysis.dut_alignment</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  


    
    



    <p class="scv-banner scv-sphinx_rtd_theme"><b>Warning:</b> This document is for the development version of Testbeam Analysis.</p>
<h1>Source code for testbeam_analysis.dut_alignment</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; All DUT alignment functions in space and time are listed here plus additional alignment check functions&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">tables</span> <span class="k">as</span> <span class="nn">tb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">minimize_scalar</span><span class="p">,</span> <span class="n">leastsq</span><span class="p">,</span> <span class="n">basinhopping</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>

<span class="kn">from</span> <span class="nn">testbeam_analysis.tools</span> <span class="k">import</span> <span class="n">analysis_utils</span>
<span class="kn">from</span> <span class="nn">testbeam_analysis.tools</span> <span class="k">import</span> <span class="n">plot_utils</span>
<span class="kn">from</span> <span class="nn">testbeam_analysis.tools</span> <span class="k">import</span> <span class="n">geometry_utils</span>
<span class="kn">from</span> <span class="nn">testbeam_analysis.tools</span> <span class="k">import</span> <span class="n">data_selection</span>

<span class="c1"># Imports for track based alignment</span>
<span class="kn">from</span> <span class="nn">testbeam_analysis.track_analysis</span> <span class="k">import</span> <span class="n">fit_tracks</span>
<span class="kn">from</span> <span class="nn">testbeam_analysis.result_analysis</span> <span class="k">import</span> <span class="n">calculate_residuals</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">OptimizeWarning</span><span class="p">)</span>  <span class="c1"># Fit errors are handled internally, turn of warnings</span>


<div class="viewcode-block" id="correlate_cluster"><a class="viewcode-back" href="../../dut_alignment.html#testbeam_analysis.dut_alignment.correlate_cluster">[docs]</a><span class="k">def</span> <span class="nf">correlate_cluster</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">,</span> <span class="n">output_correlation_file</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dut_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">4999999</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;&quot;Calculates the correlation histograms from the cluster arrays.</span>
<span class="sd">    The 2D correlation array of pairs of two different devices are created on event basis.</span>
<span class="sd">    All permutations are considered (all clusters of the first device are correlated with all clusters of the second device).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_cluster_files : iterable</span>
<span class="sd">        Iterable of filenames of the cluster files.</span>
<span class="sd">    output_correlation_file : string</span>
<span class="sd">        Filename of the output correlation file with the correlation histograms.</span>
<span class="sd">    n_pixels : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the total number of pixels (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(80, 336), (80, 336)].</span>
<span class="sd">    pixel_size : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the pixel dimension (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(250, 50), (250, 50)].</span>
<span class="sd">        If None, assuming same pixel size for all DUTs.</span>
<span class="sd">    dut_names : iterable of strings</span>
<span class="sd">        Names of the DUTs. If None, the DUT index will be used.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, create additional output plots.</span>
<span class="sd">    chunk_size : uint</span>
<span class="sd">        Chunk size of the data when reading from file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=== Correlating the index of </span><span class="si">%d</span><span class="s1"> DUTs ===&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">output_correlation_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_h5</span><span class="p">:</span>
        <span class="n">n_duts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">)</span>

        <span class="c1"># Result arrays to be filled</span>
        <span class="n">column_correlations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">row_correlations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_duts</span><span class="p">):</span>
            <span class="n">shape_column</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_pixels</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">shape_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_pixels</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">column_correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape_column</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span>
            <span class="n">row_correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape_row</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span>

        <span class="n">start_indices</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_duts</span>  <span class="c1"># Store the loop indices for speed up</span>

        <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>  <span class="c1"># Open DUT0 cluster file</span>
            <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">AdaptiveETA</span><span class="p">()],</span> <span class="n">maxval</span><span class="o">=</span><span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">term_width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>  <span class="c1"># Provide worker pool</span>
            <span class="k">for</span> <span class="n">cluster_dut_0</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="n">start_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>  <span class="c1"># Loop over the cluster of DUT0 in chunks</span>
                <span class="n">actual_event_numbers</span> <span class="o">=</span> <span class="n">cluster_dut_0</span><span class="p">[:][</span><span class="s1">&#39;event_number&#39;</span><span class="p">]</span>

                <span class="c1"># Create correlation histograms to the reference device for all other devices</span>
                <span class="c1"># Do this in parallel to safe time</span>

                <span class="n">dut_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">dut_index</span><span class="p">,</span> <span class="n">cluster_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># Loop over the other cluster files</span>
                    <span class="n">dut_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">_correlate_cluster</span><span class="p">,</span> <span class="n">kwds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cluster_dut_0&#39;</span><span class="p">:</span> <span class="n">cluster_dut_0</span><span class="p">,</span>
                                                                                  <span class="s1">&#39;cluster_file&#39;</span><span class="p">:</span> <span class="n">cluster_file</span><span class="p">,</span>
                                                                                  <span class="s1">&#39;start_index&#39;</span><span class="p">:</span> <span class="n">start_indices</span><span class="p">[</span><span class="n">dut_index</span><span class="p">],</span>
                                                                                  <span class="s1">&#39;start_event_number&#39;</span><span class="p">:</span> <span class="n">actual_event_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                  <span class="s1">&#39;stop_event_number&#39;</span><span class="p">:</span> <span class="n">actual_event_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                                                  <span class="s1">&#39;column_correlation&#39;</span><span class="p">:</span> <span class="n">column_correlations</span><span class="p">[</span><span class="n">dut_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                                                  <span class="s1">&#39;row_correlation&#39;</span><span class="p">:</span> <span class="n">row_correlations</span><span class="p">[</span><span class="n">dut_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                                                  <span class="s1">&#39;chunk_size&#39;</span><span class="p">:</span> <span class="n">chunk_size</span>
                                                                                  <span class="p">}</span>
                                                        <span class="p">))</span>
                <span class="c1"># Collect results when available</span>
                <span class="k">for</span> <span class="n">dut_index</span><span class="p">,</span> <span class="n">dut_result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dut_results</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">start_indices</span><span class="p">[</span><span class="n">dut_index</span><span class="p">],</span> <span class="n">column_correlations</span><span class="p">[</span><span class="n">dut_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row_correlations</span><span class="p">[</span><span class="n">dut_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="n">dut_result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">start_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Store the correlation histograms</span>
        <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">out_col</span> <span class="o">=</span> <span class="n">out_file_h5</span><span class="o">.</span><span class="n">create_carray</span><span class="p">(</span><span class="n">out_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CorrelationColumn_</span><span class="si">%d</span><span class="s1">_0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Column Correlation between DUT</span><span class="si">%d</span><span class="s1"> and DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">atom</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Atom</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">column_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">column_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">out_row</span> <span class="o">=</span> <span class="n">out_file_h5</span><span class="o">.</span><span class="n">create_carray</span><span class="p">(</span><span class="n">out_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CorrelationRow_</span><span class="si">%d</span><span class="s1">_0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Row Correlation between DUT</span><span class="si">%d</span><span class="s1"> and DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">atom</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Atom</span><span class="o">.</span><span class="n">from_dtype</span><span class="p">(</span><span class="n">row_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">row_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">out_col</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="n">dut_index</span><span class="p">])]</span>
            <span class="n">out_row</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="n">dut_index</span><span class="p">])]</span>
            <span class="n">out_col</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">column_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span>
            <span class="n">out_row</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">row_correlations</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span>
        <span class="n">progress_bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_correlations</span><span class="p">(</span><span class="n">input_correlation_file</span><span class="o">=</span><span class="n">output_correlation_file</span><span class="p">,</span> <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span> <span class="n">dut_names</span><span class="o">=</span><span class="n">dut_names</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_cluster_data"><a class="viewcode-back" href="../../dut_alignment.html#testbeam_analysis.dut_alignment.merge_cluster_data">[docs]</a><span class="k">def</span> <span class="nf">merge_cluster_data</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">,</span> <span class="n">output_merged_file</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">4999999</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Takes the cluster from all cluster files and merges them into one big table aligned at a common event number.</span>
<span class="sd">    </span>
<span class="sd">    Empty entries are signaled with column = row = charge = nan. Position is translated from indices to um. The</span>
<span class="sd">    local coordinate system origin (0, 0) is defined in the sensor center, to decouple translation and rotation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_cluster_files : list of pytables files</span>
<span class="sd">        File name of the input cluster files with correlation data.</span>
<span class="sd">    output_merged_file : pytables file</span>
<span class="sd">        File name of the output tracklet file.</span>
<span class="sd">    n_pixels : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the total number of pixels (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(80, 336), (80, 336)].</span>
<span class="sd">    pixel_size : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the pixel dimension (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(250, 50), (250, 50)].</span>
<span class="sd">    chunk_size : uint</span>
<span class="sd">        Chunk size of the data when reading from file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=== Merge cluster from </span><span class="si">%d</span><span class="s1"> DUTSs to merged hit file ===&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">))</span>

    <span class="c1"># Create result array description, depends on the number of DUTs</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;event_number&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">):</span>
        <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">):</span>
        <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">):</span>
        <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">):</span>
        <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;charge_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;track_quality&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)])</span>

    <span class="n">start_indices_merging_loop</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">)</span>  <span class="c1"># Store the merging loop indices for speed up</span>
    <span class="n">start_indices_data_loop</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">)</span>  <span class="c1"># Additional store indices for the data loop</span>
    <span class="n">actual_start_event_number</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Defines the first event number of the actual chunk for speed up. Cannot be deduced from DUT0, since this DUT could have missing event numbers.</span>

    <span class="c1"># Merge the cluster data from different DUTs into one table</span>
    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">output_merged_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_h5</span><span class="p">:</span>
        <span class="n">merged_cluster_table</span> <span class="o">=</span> <span class="n">out_file_h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">out_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MergedCluster&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Merged cluster on event number&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>  <span class="c1"># Open DUT0 cluster file</span>
            <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">AdaptiveETA</span><span class="p">()],</span> <span class="n">maxval</span><span class="o">=</span><span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">term_width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cluster_dut_0</span><span class="p">,</span> <span class="n">start_indices_data_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="n">start_indices_data_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">start_event_number</span><span class="o">=</span><span class="n">actual_start_event_number</span><span class="p">,</span> <span class="n">stop_event_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>  <span class="c1"># Loop over the cluster of DUT0 in chunks</span>
                <span class="n">actual_event_numbers</span> <span class="o">=</span> <span class="n">cluster_dut_0</span><span class="p">[:][</span><span class="s1">&#39;event_number&#39;</span><span class="p">]</span>

                <span class="c1"># First loop: calculate the minimum event number indices needed to merge all cluster from all files to this event number index</span>
                <span class="n">common_event_numbers</span> <span class="o">=</span> <span class="n">actual_event_numbers</span>
                <span class="k">for</span> <span class="n">dut_index</span><span class="p">,</span> <span class="n">cluster_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># Loop over the other cluster files</span>
                    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">cluster_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">actual_in_file_h5</span><span class="p">:</span>  <span class="c1"># Open DUT0 cluster file</span>
                        <span class="k">for</span> <span class="n">actual_cluster</span><span class="p">,</span> <span class="n">start_indices_merging_loop</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">actual_in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="n">start_indices_merging_loop</span><span class="p">[</span><span class="n">dut_index</span><span class="p">],</span> <span class="n">start_event_number</span><span class="o">=</span><span class="n">actual_start_event_number</span><span class="p">,</span> <span class="n">stop_event_number</span><span class="o">=</span><span class="n">actual_event_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">fail_on_missing_events</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># Loop over the cluster in the actual cluster file in chunks</span>
                            <span class="n">common_event_numbers</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">get_max_events_in_both_arrays</span><span class="p">(</span><span class="n">common_event_numbers</span><span class="p">,</span> <span class="n">actual_cluster</span><span class="p">[:][</span><span class="s1">&#39;event_number&#39;</span><span class="p">])</span>
                <span class="n">merged_cluster_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">common_event_numbers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>  <span class="c1"># Result array to be filled. For no hit: column = row = charge = NaN</span>

                <span class="c1"># Set the event number</span>
                <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;event_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_event_numbers</span><span class="p">[:]</span>

                <span class="c1"># Fill result array with DUT 0 data</span>
                <span class="n">actual_cluster</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">map_cluster</span><span class="p">(</span><span class="n">common_event_numbers</span><span class="p">,</span> <span class="n">cluster_dut_0</span><span class="p">)</span>
                <span class="c1"># Select real hits, values with nan are virtual hits</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_column&#39;</span><span class="p">])</span>
                <span class="c1"># Convert indices to positions, origin defined in the center of the sensor</span>
                <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;x_dut_0&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_column&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;y_dut_0&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_row&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;z_dut_0&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;charge_dut_0&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span>

                <span class="c1"># Fill result array with other DUT data</span>
                <span class="c1"># Second loop: get the cluster from all files and merge them to the common event number</span>
                <span class="k">for</span> <span class="n">dut_index</span><span class="p">,</span> <span class="n">cluster_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_cluster_files</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># Loop over the other cluster files</span>
                    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">cluster_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">actual_in_file_h5</span><span class="p">:</span>  <span class="c1"># Open other DUT cluster file</span>
                        <span class="k">for</span> <span class="n">actual_cluster</span><span class="p">,</span> <span class="n">start_indices_data_loop</span><span class="p">[</span><span class="n">dut_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">actual_in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="n">start_indices_data_loop</span><span class="p">[</span><span class="n">dut_index</span><span class="p">],</span> <span class="n">start_event_number</span><span class="o">=</span><span class="n">common_event_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stop_event_number</span><span class="o">=</span><span class="n">common_event_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">fail_on_missing_events</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># Loop over the cluster in the actual cluster file in chunks</span>
                            <span class="n">actual_cluster</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">map_cluster</span><span class="p">(</span><span class="n">common_event_numbers</span><span class="p">,</span> <span class="n">actual_cluster</span><span class="p">)</span>
                            <span class="c1"># Select real hits, values with nan are virtual hits</span>
                            <span class="n">selection</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_column&#39;</span><span class="p">])</span>
                            <span class="c1"># Convert indices to positions, origin in the center of the sensor, remaining DUTs</span>
                            <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span><span class="p">)][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_column&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixels</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span><span class="p">)][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;mean_row&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixels</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span><span class="p">)][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">merged_cluster_array</span><span class="p">[</span><span class="s1">&#39;charge_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dut_index</span><span class="p">)][</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_cluster</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span>

                <span class="n">merged_cluster_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_cluster_array</span><span class="p">)</span>
                <span class="n">actual_start_event_number</span> <span class="o">=</span> <span class="n">common_event_numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Set the starting event number for the next chunked read</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">start_indices_data_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">progress_bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>


<div class="viewcode-block" id="prealignment"><a class="viewcode-back" href="../../dut_alignment.html#testbeam_analysis.dut_alignment.prealignment">[docs]</a><span class="k">def</span> <span class="nf">prealignment</span><span class="p">(</span><span class="n">input_correlation_file</span><span class="p">,</span> <span class="n">output_alignment_file</span><span class="p">,</span> <span class="n">z_positions</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">s_n</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fit_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reduce_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dut_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">non_interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Deduce a pre-alignment from the correlations, by fitting the correlations with a straight line (gives offset, slope, but no tild angles).</span>
<span class="sd">       The user can define cuts on the fit error and straight line offset in an interactive way.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_correlation_file : string</span>
<span class="sd">        Filename of the input correlation file.</span>
<span class="sd">    output_alignment_file : string</span>
<span class="sd">        Filename of the output alignment file.</span>
<span class="sd">    z_positions : iterable</span>
<span class="sd">        The z positions of the DUTs in um.</span>
<span class="sd">    pixel_size : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the pixel dimension (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(250, 50), (250, 50)].</span>
<span class="sd">    s_n : float</span>
<span class="sd">        The signal to noise ratio for peak signal over background peak. This should be specified when the background is fitted with a gaussian function.</span>
<span class="sd">        Usually data with a lot if tracks per event have a gaussian background. A good S/N value can be estimated by investigating the correlation plot.</span>
<span class="sd">        The default value is usually fine.</span>
<span class="sd">    fit_background : bool</span>
<span class="sd">        Data with a lot if tracks per event have a gaussian background from the beam profile. Also try to fit this background to determine the correlation</span>
<span class="sd">        peak correctly. If you see a clear 2D gaussian in the correlation plot this shoud be activated. If you have 1-2 tracks per event and large pixels</span>
<span class="sd">        this option should be off, because otherwise overfitting is possible.</span>
<span class="sd">    reduce_background : bool</span>
<span class="sd">        Reduce background (uncorrelated events) by using SVD of the 2D correlation array.</span>
<span class="sd">    dut_names: iterable</span>
<span class="sd">        Names of the DUTs. If None, the DUT index will be used.</span>
<span class="sd">    no_fit : bool</span>
<span class="sd">        Use Hough transformation to calculate slope and offset.</span>
<span class="sd">    non_interactive : bool</span>
<span class="sd">        Deactivate user interaction and estimate fit range automatically.</span>
<span class="sd">    iterations : uint</span>
<span class="sd">        The number of iterations in non-interactive mode.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, create additional output plots.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=== Pre-alignment ===&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">no_fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reduce_background</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no_fit is True, setting reduce_background to True&quot;</span><span class="p">)</span>
            <span class="n">reduce_background</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">reduce_background</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fit_background</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;reduce_background is True, setting fit_background to False&quot;</span><span class="p">)</span>
            <span class="n">fit_background</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output_pdf</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_alignment_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_prealigned.pdf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_pdf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_correlation_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>
        <span class="n">n_duts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_file_h5</span><span class="o">.</span><span class="n">list_nodes</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># no correlation for reference DUT0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_duts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;DUT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_c0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_c0_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_c1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_c1_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_sigma&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;column_sigma_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_c0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_c0_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_c1&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_c1_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_sigma&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;row_sigma_error&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)])</span>
        <span class="c1"># Set std. settings for reference DUT0</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;column_c0&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;column_c0_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;column_c1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;column_c1_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;row_c0&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;row_c0_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;row_c1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;row_c1_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">table_prefix</span> <span class="o">=</span> <span class="s1">&#39;column&#39;</span> <span class="k">if</span> <span class="s1">&#39;column&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;row&#39;</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;\d+&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">dut_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ref_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="s1">&#39;DUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dut_idx</span>
            <span class="n">dut_name</span> <span class="o">=</span> <span class="n">dut_names</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">dut_names</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;DUT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dut_idx</span><span class="p">))</span>
            <span class="n">ref_name</span> <span class="o">=</span> <span class="n">dut_names</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">dut_names</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;DUT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_idx</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aligning data from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;column&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">pixel_size_dut</span><span class="p">,</span> <span class="n">pixel_size_ref</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixel_size_dut</span><span class="p">,</span> <span class="n">pixel_size_ref</span> <span class="o">=</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">ref_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="p">[:]</span>

            <span class="n">n_pixel_dut</span><span class="p">,</span> <span class="n">n_pixel_ref</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Initialize arrays with np.nan (invalid), adding 0.5 to change from index to position</span>
            <span class="c1"># matrix index 0 is cluster index 1 ranging from 0.5 to 1.4999, which becomes position 0.0 to 0.999 with center at 0.5, etc.</span>
            <span class="n">x_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_pixel_ref</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_pixel_ref</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">x_dut</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_pixel_dut</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_pixel_dut</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">coeff_fitted</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_pixel_dut</span>
            <span class="n">mean_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_pixel_dut</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>  <span class="c1"># Peak of the Gauss fit</span>
            <span class="n">mean_fitted</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">mean_error_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_pixel_dut</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>  <span class="c1"># Error of the fit of the peak</span>
            <span class="n">mean_error_fitted</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">sigma_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_pixel_dut</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>  <span class="c1"># Sigma of the Gauss fit</span>
            <span class="n">sigma_fitted</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_pixel_dut</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>  <span class="c1"># Chi2 of the fit</span>
            <span class="n">chi2</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">n_cluster</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Number of hits per bin</span>

            <span class="k">if</span> <span class="n">reduce_background</span><span class="p">:</span>
                <span class="n">uu</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># sigular value decomposition</span>
                <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">uu</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dd</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">vv</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># take first sigular value for background</span>
                <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c1"># make Numpy array</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c1"># remove background</span>
                <span class="n">data</span> <span class="o">-=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>  <span class="c1"># only positive values</span>

            <span class="k">if</span> <span class="n">no_fit</span><span class="p">:</span>
                <span class="c1"># calculate half hight</span>
                <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">median_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">half_median_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">median</span> <span class="o">+</span> <span class="n">median_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="c1"># calculate maximum per column</span>
                <span class="n">max_select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hough_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">hough_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">max_select</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># select maximums if larger than half hight</span>
                <span class="n">hough_data</span> <span class="o">=</span> <span class="n">hough_data</span> <span class="o">&amp;</span> <span class="n">half_median_data</span>
                <span class="c1"># transpose for correct angle</span>
                <span class="n">hough_data</span> <span class="o">=</span> <span class="n">hough_data</span><span class="o">.</span><span class="n">T</span>
                <span class="n">accumulator</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">theta_edges</span><span class="p">,</span> <span class="n">rho_edges</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">hough_transform</span><span class="p">(</span><span class="n">hough_data</span><span class="p">,</span> <span class="n">theta_res</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">rho_res</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">return_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rho_idx</span><span class="p">,</span> <span class="n">th_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">accumulator</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">accumulator</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">rho_val</span><span class="p">,</span> <span class="n">theta_val</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">rho_idx</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">th_idx</span><span class="p">]</span>
                <span class="n">slope_idx</span><span class="p">,</span> <span class="n">offset_idx</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_val</span><span class="p">),</span> <span class="n">rho_val</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_val</span><span class="p">)</span>
                <span class="n">slope</span> <span class="o">=</span> <span class="n">slope_idx</span> <span class="o">*</span> <span class="p">(</span><span class="n">pixel_size_ref</span> <span class="o">/</span> <span class="n">pixel_size_dut</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_idx</span> <span class="o">*</span> <span class="n">pixel_size_ref</span>
                <span class="c1"># offset in the center of the pixel matrix</span>
                <span class="n">offset_center</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">pixel_size_dut</span> <span class="o">*</span> <span class="n">n_pixel_dut</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">pixel_size_ref</span> <span class="o">*</span> <span class="n">n_pixel_ref</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="n">offset_center</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pixel_size_ref</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pixel_size_dut</span>  <span class="c1"># correct for half bin</span>

                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c0&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c0_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_center</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c1_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_sigma&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_sigma_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_positions</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">]</span>

                <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_hough</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_dut</span><span class="p">,</span>
                                      <span class="n">data</span><span class="o">=</span><span class="n">hough_data</span><span class="p">,</span>
                                      <span class="n">accumulator</span><span class="o">=</span><span class="n">accumulator</span><span class="p">,</span>
                                      <span class="n">offset</span><span class="o">=</span><span class="n">offset_idx</span><span class="p">,</span>
                                      <span class="n">slope</span><span class="o">=</span><span class="n">slope_idx</span><span class="p">,</span>
                                      <span class="n">theta_edges</span><span class="o">=</span><span class="n">theta_edges</span><span class="p">,</span>
                                      <span class="n">rho_edges</span><span class="o">=</span><span class="n">rho_edges</span><span class="p">,</span>
                                      <span class="n">n_pixel_ref</span><span class="o">=</span><span class="n">n_pixel_ref</span><span class="p">,</span>
                                      <span class="n">n_pixel_dut</span><span class="o">=</span><span class="n">n_pixel_dut</span><span class="p">,</span>
                                      <span class="n">pixel_size_ref</span><span class="o">=</span><span class="n">pixel_size_ref</span><span class="p">,</span>
                                      <span class="n">pixel_size_dut</span><span class="o">=</span><span class="n">pixel_size_dut</span><span class="p">,</span>
                                      <span class="n">ref_name</span><span class="o">=</span><span class="n">ref_name</span><span class="p">,</span>
                                      <span class="n">dut_name</span><span class="o">=</span><span class="n">dut_name</span><span class="p">,</span>
                                      <span class="n">prefix</span><span class="o">=</span><span class="n">table_prefix</span><span class="p">,</span>
                                      <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fill the arrays from above with values</span>
                <span class="n">_fit_data</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_ref</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">s_n</span><span class="o">=</span><span class="n">s_n</span><span class="p">,</span> <span class="n">coeff_fitted</span><span class="o">=</span><span class="n">coeff_fitted</span><span class="p">,</span> <span class="n">mean_fitted</span><span class="o">=</span><span class="n">mean_fitted</span><span class="p">,</span> <span class="n">mean_error_fitted</span><span class="o">=</span><span class="n">mean_error_fitted</span><span class="p">,</span> <span class="n">sigma_fitted</span><span class="o">=</span><span class="n">sigma_fitted</span><span class="p">,</span> <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">,</span> <span class="n">fit_background</span><span class="o">=</span><span class="n">fit_background</span><span class="p">,</span> <span class="n">reduce_background</span><span class="o">=</span><span class="n">reduce_background</span><span class="p">)</span>

                <span class="c1"># Convert fit results to metric units for alignment fit</span>
                <span class="c1"># Origin is center of pixel matrix</span>
                <span class="n">x_dut_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_dut</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixel_dut</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size_dut</span>
                <span class="n">mean_fitted_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_fitted</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_pixel_ref</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size_ref</span>
                <span class="n">mean_error_fitted_scaled</span> <span class="o">=</span> <span class="n">mean_error_fitted</span> <span class="o">*</span> <span class="n">pixel_size_ref</span>

                <span class="c1"># Selected data arrays</span>
                <span class="n">x_selected</span> <span class="o">=</span> <span class="n">x_dut</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">x_dut_scaled_selected</span> <span class="o">=</span> <span class="n">x_dut_scaled</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mean_fitted_scaled_selected</span> <span class="o">=</span> <span class="n">mean_fitted_scaled</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mean_error_fitted_scaled_selected</span> <span class="o">=</span> <span class="n">mean_error_fitted_scaled</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">sigma_fitted_selected</span> <span class="o">=</span> <span class="n">sigma_fitted</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">chi2_selected</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">n_cluster_selected</span> <span class="o">=</span> <span class="n">n_cluster</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Show the straigt line correlation fit including fit errors and offsets from the fit</span>
                <span class="c1"># Let the user change the cuts (error limit, offset limit) and refit until result looks good</span>
                <span class="n">refit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">selected_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_dut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">actual_iteration</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Refit counter for non interactive mode</span>
                <span class="k">while</span><span class="p">(</span><span class="n">refit</span><span class="p">):</span>
                    <span class="n">selected_data</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">refit</span> <span class="o">=</span> <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_prealignments</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_dut_scaled_selected</span><span class="p">,</span>
                                                                              <span class="n">mean_fitted</span><span class="o">=</span><span class="n">mean_fitted_scaled_selected</span><span class="p">,</span>
                                                                              <span class="n">mean_error_fitted</span><span class="o">=</span><span class="n">mean_error_fitted_scaled_selected</span><span class="p">,</span>
                                                                              <span class="n">n_cluster</span><span class="o">=</span><span class="n">n_cluster_selected</span><span class="p">,</span>
                                                                              <span class="n">ref_name</span><span class="o">=</span><span class="n">ref_name</span><span class="p">,</span>
                                                                              <span class="n">dut_name</span><span class="o">=</span><span class="n">dut_name</span><span class="p">,</span>
                                                                              <span class="n">prefix</span><span class="o">=</span><span class="n">table_prefix</span><span class="p">,</span>
                                                                              <span class="n">non_interactive</span><span class="o">=</span><span class="n">non_interactive</span><span class="p">)</span>
                    <span class="n">x_selected</span> <span class="o">=</span> <span class="n">x_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">x_dut_scaled_selected</span> <span class="o">=</span> <span class="n">x_dut_scaled_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">mean_fitted_scaled_selected</span> <span class="o">=</span> <span class="n">mean_fitted_scaled_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">mean_error_fitted_scaled_selected</span> <span class="o">=</span> <span class="n">mean_error_fitted_scaled_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">sigma_fitted_selected</span> <span class="o">=</span> <span class="n">sigma_fitted_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">chi2_selected</span> <span class="o">=</span> <span class="n">chi2_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="n">n_cluster_selected</span> <span class="o">=</span> <span class="n">n_cluster_selected</span><span class="p">[</span><span class="n">selected_data</span><span class="p">]</span>
                    <span class="c1"># Stop in non interactive mode if the number of refits (iterations) is reached</span>
                    <span class="k">if</span> <span class="n">non_interactive</span><span class="p">:</span>
                        <span class="n">actual_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">actual_iteration</span> <span class="o">&gt;=</span> <span class="n">iterations</span><span class="p">:</span>
                            <span class="k">break</span>

                <span class="c1"># Linear fit, usually describes correlation very well, slope is close to 1.</span>
                <span class="c1"># With low energy beam and / or beam with diverse agular distribution, the correlation will not be perfectly straight</span>
                <span class="c1"># Use results from straight line fit as start values for this final fit</span>
                <span class="n">re_fit</span><span class="p">,</span> <span class="n">re_fit_pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">x_dut_scaled_selected</span><span class="p">,</span> <span class="n">mean_fitted_scaled_selected</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">mean_error_fitted_scaled_selected</span><span class="p">,</span> <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

                <span class="c1"># Write fit results to array</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c0&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c0_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">re_fit_pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_c1_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_fit</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">re_fit_pcov</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_positions</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">]</span>

                <span class="c1"># Calculate mean sigma (is a residual when assuming straight tracks) and its error and store the actual data in result array</span>
                <span class="c1"># This error is needed for track finding and track quality determination</span>
                <span class="n">mean_sigma</span> <span class="o">=</span> <span class="n">pixel_size_ref</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_fitted_selected</span><span class="p">))</span>
                <span class="n">mean_sigma_error</span> <span class="o">=</span> <span class="n">pixel_size_ref</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_fitted_selected</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_fitted_selected</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_sigma&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="n">dut_idx</span><span class="p">][</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s1">&#39;_sigma_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_sigma</span><span class="p">,</span> <span class="n">mean_sigma_error</span>

                <span class="c1"># Calculate the index of the beam center based on valid indices</span>
                <span class="n">plot_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x_selected</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_selected</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)])</span>
                <span class="c1"># Find nearest valid index to the calculated index</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_selected</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">plot_index</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="n">plot_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_selected</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

                <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">x_ref</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">stop</span><span class="o">=</span><span class="n">x_ref</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">indices_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">plot_index</span><span class="p">)</span>
                <span class="n">indices_higher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">plot_index</span><span class="p">,</span> <span class="n">n_pixel_dut</span><span class="p">)</span>
                <span class="n">alternating_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">indices_higher</span><span class="p">,</span> <span class="n">indices_lower</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">indices_lower</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">indices_higher</span><span class="p">])))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">unique_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">alternating_indices</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">alternating_indices</span> <span class="o">=</span> <span class="n">alternating_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">unique_indices</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">plot_index</span> <span class="ow">in</span> <span class="n">alternating_indices</span><span class="p">:</span>
                    <span class="n">plot_correlation_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">coeff_fitted</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plot_correlation_fit</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">plot_correlation_fit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">coeff_fitted</span><span class="p">[</span><span class="n">plot_index</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])):</span>
                        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">gauss_offset</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">coeff_fitted</span><span class="p">[</span><span class="n">plot_index</span><span class="p">][[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
                        <span class="n">fit_label</span> <span class="o">=</span> <span class="s2">&quot;Gauss-Offset&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">double_gauss_offset</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">coeff_fitted</span><span class="p">[</span><span class="n">plot_index</span><span class="p">])</span>
                        <span class="n">fit_label</span> <span class="o">=</span> <span class="s2">&quot;Gauss-Gauss-Offset&quot;</span>

                    <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_correlation_fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_ref</span><span class="p">,</span>
                                                    <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">plot_index</span><span class="p">,</span> <span class="p">:],</span>
                                                    <span class="n">x_fit</span><span class="o">=</span><span class="n">x_fit</span><span class="p">,</span>
                                                    <span class="n">y_fit</span><span class="o">=</span><span class="n">y_fit</span><span class="p">,</span>
                                                    <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;Column&quot;</span> <span class="k">if</span> <span class="s2">&quot;column&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Row&quot;</span><span class="p">,</span> <span class="n">ref_name</span><span class="p">),</span>
                                                    <span class="n">fit_label</span><span class="o">=</span><span class="n">fit_label</span><span class="p">,</span>
                                                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Correlation of </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> vs. </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_prefix</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">ref_name</span><span class="p">,</span> <span class="n">dut_name</span><span class="p">,</span> <span class="n">table_prefix</span><span class="p">,</span> <span class="n">plot_index</span><span class="p">),</span>
                                                    <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot plot correlation fit, no fit data available&quot;</span><span class="p">)</span>

                <span class="c1"># Plot selected data with fit</span>
                <span class="n">fit_fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">re_fit</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">selected_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x_dut_scaled</span><span class="p">,</span> <span class="n">x_dut_scaled_selected</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_dut_scaled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_prealignment_fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_dut_scaled</span><span class="p">,</span>
                                                 <span class="n">mean_fitted</span><span class="o">=</span><span class="n">mean_fitted_scaled</span><span class="p">,</span>
                                                 <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                 <span class="n">fit_fn</span><span class="o">=</span><span class="n">fit_fn</span><span class="p">,</span>
                                                 <span class="n">fit</span><span class="o">=</span><span class="n">re_fit</span><span class="p">,</span>
                                                 <span class="n">pcov</span><span class="o">=</span><span class="n">re_fit_pcov</span><span class="p">,</span>
                                                 <span class="n">chi2</span><span class="o">=</span><span class="n">chi2</span><span class="p">,</span>
                                                 <span class="n">mean_error_fitted</span><span class="o">=</span><span class="n">mean_error_fitted_scaled</span><span class="p">,</span>
                                                 <span class="n">n_cluster</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span>
                                                 <span class="n">n_pixel_ref</span><span class="o">=</span><span class="n">n_pixel_ref</span><span class="p">,</span>
                                                 <span class="n">n_pixel_dut</span><span class="o">=</span><span class="n">n_pixel_dut</span><span class="p">,</span>
                                                 <span class="n">pixel_size_ref</span><span class="o">=</span><span class="n">pixel_size_ref</span><span class="p">,</span>
                                                 <span class="n">pixel_size_dut</span><span class="o">=</span><span class="n">pixel_size_dut</span><span class="p">,</span>
                                                 <span class="n">ref_name</span><span class="o">=</span><span class="n">ref_name</span><span class="p">,</span>
                                                 <span class="n">dut_name</span><span class="o">=</span><span class="n">dut_name</span><span class="p">,</span>
                                                 <span class="n">prefix</span><span class="o">=</span><span class="n">table_prefix</span><span class="p">,</span>
                                                 <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Store pre-alignment data in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output_alignment_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">output_alignment_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_h5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result_table</span> <span class="o">=</span> <span class="n">out_file_h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">out_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;PreAlignment&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Prealignment alignment from correlation&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">result_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">tb</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NodeError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Coarse alignment table exists already. Do not create new.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">_fit_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">coeff_fitted</span><span class="p">,</span> <span class="n">mean_fitted</span><span class="p">,</span> <span class="n">mean_error_fitted</span><span class="p">,</span> <span class="n">sigma_fitted</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">fit_background</span><span class="p">,</span> <span class="n">reduce_background</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">calc_limits_from_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coeff</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculates the fit limits from the last successfull fit.&#39;&#39;&#39;</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
            <span class="p">[</span><span class="mf">10.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
        <span class="p">]</span>
        <span class="c1"># Fix too small sigma, sigma &lt; 1 is unphysical</span>
        <span class="k">if</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="k">return</span> <span class="n">limits</span>

    <span class="k">def</span> <span class="nf">signal_sanity_check</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">A_peak</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Sanity check if signal was deducted correctly from background.</span>

<span class="sd">            3 Conditions:</span>
<span class="sd">            1. The given signal to noise value has to be fullfilled: S/N &gt; Amplitude Signal / ( Amplidude background + Offset)</span>
<span class="sd">            2. The signal + background has to be large enough: Amplidute 1 + Amplitude 2 + Offset &gt; Data maximum / 2</span>
<span class="sd">            3. The Signal Sigma has to be smaller than the background sigma, otherwise beam would be larger than one pixel pitch</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">*</span> <span class="n">s_n</span> <span class="ow">or</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">A_peak</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="ow">or</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">n_pixel_dut</span><span class="p">,</span> <span class="n">n_pixel_ref</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Start values for fitting</span>
    <span class="c1"># Correlation peak</span>
    <span class="n">mu_peak</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">A_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># signal / correlation peak</span>
    <span class="c1"># Background of uncorrelated data</span>
    <span class="n">n_entries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">A_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># noise / background halo</span>
    <span class="n">mu_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">n_entries</span><span class="p">)</span>
    <span class="n">mu_background</span><span class="p">[</span><span class="n">n_entries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">x</span><span class="p">)[</span><span class="n">n_entries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_entries</span><span class="p">[</span><span class="n">n_entries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">coeff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># To signal that las fit was good, thus the results can be taken as start values for next fit</span>

    <span class="c1"># for logging</span>
    <span class="n">no_correlation_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">few_correlation_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># get index of the highest background value</span>
    <span class="n">fit_start_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">A_background</span><span class="p">)</span>
    <span class="n">indices_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fit_start_index</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">indices_higher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fit_start_index</span><span class="p">,</span> <span class="n">n_pixel_dut</span><span class="p">)</span>
    <span class="n">stacked_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">indices_lower</span><span class="p">,</span> <span class="n">indices_higher</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">stacked_indices</span><span class="p">:</span>  <span class="c1"># Loop over x dimension of correlation histogram</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">fit_start_index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">coeff_fitted</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff_fitted</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># TODO: start fitting from the beam center to get a higher chance to pick up the correlation peak</span>

        <span class="c1"># omit correlation fit with no entries / correlation (e.g. sensor edges, masked columns)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">no_correlation_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># omit correlation fit if sum of correlation entries is &lt; 1 % of total entries devided by number of indices</span>
        <span class="c1"># (e.g. columns not in the beam)</span>
        <span class="n">n_cluster_curr_index</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fit_converged</span> <span class="ow">and</span> <span class="n">n_cluster_curr_index</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_pixel_dut</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">few_correlation_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Set start parameters and fit limits</span>
        <span class="c1"># Parameters: A_1, mu_1, sigma_1, A_2, mu_2, sigma_2, offset</span>
        <span class="k">if</span> <span class="n">fit_converged</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reduce_background</span><span class="p">:</span>  <span class="c1"># Set start values from last successfull fit, no large difference expected</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">coeff</span>  <span class="c1"># Set start values from last successfull fit</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">calc_limits_from_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>  <span class="c1"># Set boundaries from previous converged fit</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># No (last) successfull fit, try to dedeuce reasonable start values</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">mu_peak</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">A_background</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">mu_background</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">get_rms_from_histogram</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">x</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="c1"># Fit correlation</span>
        <span class="k">if</span> <span class="n">fit_background</span><span class="p">:</span>  <span class="c1"># Describe background with addidional gauss + offset</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coeff</span><span class="p">,</span> <span class="n">var_matrix</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">double_gauss_offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># curve_fit failed</span>
                <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># do some result checks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">signal_sanity_check</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">]):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No correlation peak found. Try another fit...&#39;</span><span class="p">)</span>
                    <span class="c1"># Use parameters from last fit as start parameters for the refit</span>
                    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">double_gauss_offset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">coeff</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coeff</span><span class="p">,</span> <span class="n">var_matrix</span> <span class="o">=</span> <span class="n">refit_advanced</span><span class="p">(</span><span class="n">x_data</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y_data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y_fit</span><span class="o">=</span><span class="n">y_fit</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">coeff</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># curve_fit failed</span>
                        <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Check result again:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">signal_sanity_check</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">A_peak</span><span class="p">[</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No correlation peak found after refit!&#39;</span><span class="p">)</span>
                            <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Describe background with offset only.</span>
            <span class="c1"># Change start parameters and boundaries</span>
            <span class="n">p0_gauss_offset</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0_val</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p0_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
            <span class="n">bounds_gauss_offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
            <span class="n">bounds_gauss_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bound_val</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bound_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
            <span class="n">bounds_gauss_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bound_val</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bound_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coeff_gauss_offset</span><span class="p">,</span> <span class="n">var_matrix</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">gauss_offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0_gauss_offset</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds_gauss_offset</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>  <span class="c1"># curve_fit failed</span>
                <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Correlation should have at least 2 entries to avoid random fluctuation peaks to be selected</span>
                <span class="k">if</span> <span class="n">coeff_gauss_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Change back coefficents</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">coeff_gauss_offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Parameters: A_1, mu_1, sigma_1, A_2, mu_2, sigma_2, offset</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_converged</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Set fit results for given index if successful</span>
        <span class="k">if</span> <span class="n">fit_converged</span><span class="p">:</span>
            <span class="n">coeff_fitted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span>
            <span class="n">mean_fitted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mean_error_fitted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">var_matrix</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sigma_fitted</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">chi2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">get_chi2</span><span class="p">(</span><span class="n">y_data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y_fit</span><span class="o">=</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">double_gauss_offset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">coeff</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">no_correlation_indices</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No correlation entries for indices </span><span class="si">%s</span><span class="s1">. Omit correlation fit.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_correlation_indices</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">few_correlation_indices</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Very few correlation entries for indices </span><span class="si">%s</span><span class="s1">. Omit correlation fit.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">few_correlation_indices</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">refit_advanced</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Substract the fit from the data, thus only the small signal peak should be left.</span>
<span class="sd">    Fit this peak, and refit everything with start values&#39;&#39;&#39;</span>
    <span class="n">y_peak</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">y_fit</span>  <span class="c1"># Fit most likely only describes background, thus substract it</span>
    <span class="n">peak_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_peak</span><span class="p">)</span>  <span class="c1"># Determine start value for amplitude</span>
    <span class="n">peak_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_peak</span><span class="p">)</span>  <span class="c1"># Determine start value for mu</span>
    <span class="n">fwhm_1</span><span class="p">,</span> <span class="n">fwhm_2</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">fwhm</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_peak</span><span class="p">)</span>
    <span class="n">peak_sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhm_2</span> <span class="o">-</span> <span class="n">fwhm_1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.35</span>  <span class="c1"># Determine start value for sigma</span>

    <span class="c1"># Fit a Gauss + Offset to the background substracted data</span>
    <span class="n">coeff_peak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">gauss_offset_slope</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_peak</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">peak_A</span><span class="p">,</span> <span class="n">peak_mu</span><span class="p">,</span> <span class="n">peak_sigma</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">peak_A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]))</span>

    <span class="c1"># Refit orignial double Gauss function with proper start values for the small signal peak</span>
    <span class="n">coeff</span><span class="p">,</span> <span class="n">var_matrix</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">analysis_utils</span><span class="o">.</span><span class="n">double_gauss_offset</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">coeff_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coeff_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coeff_peak</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p0</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">var_matrix</span>


<div class="viewcode-block" id="apply_alignment"><a class="viewcode-back" href="../../dut_alignment.html#testbeam_analysis.dut_alignment.apply_alignment">[docs]</a><span class="k">def</span> <span class="nf">apply_alignment</span><span class="p">(</span><span class="n">input_hit_file</span><span class="p">,</span> <span class="n">input_alignment_file</span><span class="p">,</span> <span class="n">output_hit_file</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_prealignment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_z</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_duts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Takes a file with tables containing hit information (x, y, z) and applies the alignment to each DUT hits positions. The alignment data is used. If this is not</span>
<span class="sd">    available a fallback to the pre-alignment is done.</span>
<span class="sd">    One can also inverse the alignment or apply the alignment without changing the z position.</span>

<span class="sd">    This function cannot be easily made faster with multiprocessing since the computation function (apply_alignment_to_chunk) does not contribute significantly to the runtime (&lt; 20 %),</span>
<span class="sd">    but the copy overhead for not shared memory needed for multipgrocessing is higher. Also the hard drive IO can be limiting (30 Mb/s read, 20 Mb/s write to the same disk)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_hit_file : string</span>
<span class="sd">        Filename of the input hits file (e.g. merged data file, tracklets file, etc.).</span>
<span class="sd">    input_alignment_file : string</span>
<span class="sd">        Filename of the input alignment file.</span>
<span class="sd">    output_hit_file : string</span>
<span class="sd">        Filename of the output hits file with hit data after alignment was applied.</span>
<span class="sd">    inverse : boolean</span>
<span class="sd">        If True, apply the inverse alignment.</span>
<span class="sd">    force_prealignment : bool</span>
<span class="sd">        If True, use pre-alignment, even if alignment data is availale.</span>
<span class="sd">    no_z : bool</span>
<span class="sd">        If True, do not change the z alignment. Needed since the z position is special for x / y based plane measurements.</span>
<span class="sd">    use_duts : iterable</span>
<span class="sd">        Iterable of DUT indices to apply the alignment to. If None, use all DUTs.</span>
<span class="sd">    chunk_size : uint</span>
<span class="sd">        Chunk size of the data when reading from file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;== Apply alignment to </span><span class="si">%s</span><span class="s1"> ==&#39;</span><span class="p">,</span> <span class="n">input_hit_file</span><span class="p">)</span>

    <span class="n">use_prealignment</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">force_prealignment</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_alignment_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>  <span class="c1"># Open file with alignment data</span>
            <span class="k">if</span> <span class="n">use_prealignment</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use pre-alignment data&#39;</span><span class="p">)</span>
                <span class="n">prealignment</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">PreAlignment</span><span class="p">[:]</span>
                <span class="n">n_duts</span> <span class="o">=</span> <span class="n">prealignment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use alignment data&#39;</span><span class="p">)</span>
                <span class="n">alignment</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Alignment</span><span class="p">[:]</span>
                <span class="n">n_duts</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># The input_alignment_file is an array</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="n">input_alignment_file</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Check if array is prealignent array</span>
            <span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;column_c0&#39;</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use pre-alignment data&#39;</span><span class="p">)</span>
            <span class="n">n_duts</span> <span class="o">=</span> <span class="n">prealignment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">use_prealignment</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use alignment data&#39;</span><span class="p">)</span>
            <span class="n">n_duts</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">use_prealignment</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">apply_alignment_to_chunk</span><span class="p">(</span><span class="n">hits_chunk</span><span class="p">,</span> <span class="n">dut_index</span><span class="p">,</span> <span class="n">use_prealignment</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">inverse</span><span class="p">,</span> <span class="n">no_z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">use_prealignment</span><span class="p">:</span>  <span class="c1"># Apply transformation from pre-alignment information</span>
            <span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span> <span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span> <span class="n">hit_z</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">apply_alignment</span><span class="p">(</span>
                <span class="n">hits_x</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">hits_y</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">hits_z</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">dut_index</span><span class="o">=</span><span class="n">dut_index</span><span class="p">,</span>
                <span class="n">prealignment</span><span class="o">=</span><span class="n">prealignment</span><span class="p">,</span>
                <span class="n">inverse</span><span class="o">=</span><span class="n">inverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Apply transformation from fine alignment information</span>
            <span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span> <span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span> <span class="n">hit_z</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">apply_alignment</span><span class="p">(</span>
                <span class="n">hits_x</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">hits_y</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">hits_z</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">],</span>
                <span class="n">dut_index</span><span class="o">=</span><span class="n">dut_index</span><span class="p">,</span>
                <span class="n">alignment</span><span class="o">=</span><span class="n">alignment</span><span class="p">,</span>
                <span class="n">inverse</span><span class="o">=</span><span class="n">inverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_z</span><span class="p">:</span>
            <span class="n">hits_chunk</span><span class="p">[</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">hit_z</span>

    <span class="c1"># Looper over the hits of all DUTs of all hit tables in chunks and apply the alignment</span>
    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_hit_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">output_hit_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file_h5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>  <span class="c1"># Loop over potential hit tables in data file</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="n">node</span>
                <span class="n">new_node_name</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">name</span>

                <span class="k">if</span> <span class="n">new_node_name</span> <span class="o">==</span> <span class="s1">&#39;MergedCluster&#39;</span><span class="p">:</span>  <span class="c1"># Merged cluster with alignment are tracklets</span>
                    <span class="n">new_node_name</span> <span class="o">=</span> <span class="s1">&#39;Tracklets&#39;</span>

                <span class="n">hits_aligned_table</span> <span class="o">=</span> <span class="n">out_file_h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">out_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">new_node_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">Filters</span><span class="p">(</span><span class="n">complib</span><span class="o">=</span><span class="s1">&#39;blosc&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fletcher32</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

                <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">AdaptiveETA</span><span class="p">()],</span> <span class="n">maxval</span><span class="o">=</span><span class="n">hits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">term_width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">hits_chunk</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">hits</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>  <span class="c1"># Loop over the hits</span>
                    <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_duts</span><span class="p">):</span>  <span class="c1"># Loop over the DUTs in the hit table</span>
                        <span class="k">if</span> <span class="n">use_duts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dut_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_duts</span><span class="p">:</span>  <span class="c1"># omit DUT</span>
                            <span class="k">continue</span>

                        <span class="n">apply_alignment_to_chunk</span><span class="p">(</span><span class="n">hits_chunk</span><span class="o">=</span><span class="n">hits_chunk</span><span class="p">,</span> <span class="n">dut_index</span><span class="o">=</span><span class="n">dut_index</span><span class="p">,</span> <span class="n">use_prealignment</span><span class="o">=</span><span class="n">use_prealignment</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">prealignment</span> <span class="k">if</span> <span class="n">use_prealignment</span> <span class="k">else</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="n">inverse</span><span class="p">,</span> <span class="n">no_z</span><span class="o">=</span><span class="n">no_z</span><span class="p">)</span>

                    <span class="n">hits_aligned_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hits_chunk</span><span class="p">)</span>
                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File with realigned hits </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output_hit_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="alignment"><a class="viewcode-back" href="../../dut_alignment.html#testbeam_analysis.dut_alignment.alignment">[docs]</a><span class="k">def</span> <span class="nf">alignment</span><span class="p">(</span><span class="n">input_track_candidates_file</span><span class="p">,</span> <span class="n">input_alignment_file</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">align_duts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection_fit_duts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection_hit_duts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selection_track_quality</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_translation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">use_n_tracks</span><span class="o">=</span><span class="mi">200000</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; This function does an alignment of the DUTs and sets translation and rotation values for all DUTs.</span>
<span class="sd">    The reference DUT defines the global coordinate system position at 0, 0, 0 and should be well in the beam and not heavily rotated.</span>

<span class="sd">    To solve the chicken-and-egg problem that a good dut alignment needs hits belonging to one track, but good track finding needs a good dut alignment this</span>
<span class="sd">    function work only on already prealigned hits belonging to one track. Thus this function can be called only after track finding.</span>

<span class="sd">    These steps are done</span>
<span class="sd">    1. Take the found tracks and revert the pre-alignment</span>
<span class="sd">    2. Take the track hits belonging to one track and fit tracks for all DUTs</span>
<span class="sd">    3. Calculate the residuals for each DUT</span>
<span class="sd">    4. Deduce rotations from the residuals and apply them to the hits</span>
<span class="sd">    5. Deduce the translation of each plane</span>
<span class="sd">    6. Store and apply the new alignment</span>

<span class="sd">    repeat step 3 - 6 until the total residual does not decrease (RMS_total = sqrt(RMS_x_1^2 + RMS_y_1^2 + RMS_x_2^2 + RMS_y_2^2 + ...))</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_track_candidates_file : string</span>
<span class="sd">        file name with the track candidates table</span>
<span class="sd">    input_alignment_file : pytables file</span>
<span class="sd">        File name of the input aligment data</span>
<span class="sd">    n_pixels : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the total number of pixels (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(80, 336), (80, 336)].</span>
<span class="sd">    pixel_size : iterable of tuples</span>
<span class="sd">        One tuple per DUT describing the pixel dimension (column/row),</span>
<span class="sd">        e.g. for two FE-I4 DUTs [(250, 50), (250, 50)].</span>
<span class="sd">    align_duts : iterable or iterable of iterable</span>
<span class="sd">        The combination of duts that are algined at once. One should always align the high resolution planes first.</span>
<span class="sd">        E.g. for a telesope (first and last 3 planes) with 2 devices in the center (3, 4):</span>
<span class="sd">        align_duts=[[0, 1, 2, 5, 6, 7],  # align the telescope planes first</span>
<span class="sd">        [4],  # Align first DUT</span>
<span class="sd">        [3]],  # Align second DUT</span>
<span class="sd">    selection_fit_duts : iterable or iterable of iterable</span>
<span class="sd">        Defines for each align_duts combination wich devices to use in the track fit.</span>
<span class="sd">        E.g. To use only the telescope planes (first and last 3 planes) but not the 2 center devices</span>
<span class="sd">        selection_fit_duts=[0, 1, 2, 5, 6, 7]</span>
<span class="sd">    selection_hit_duts : iterable or iterable of iterable</span>
<span class="sd">        Defines for each align_duts combination wich devices must have a hit to use the track for fitting. The hit</span>
<span class="sd">        does not have to be used in the fit itself! This is useful for time reference planes.</span>
<span class="sd">        E.g.  To use telescope planes (first and last 3 planes) + time reference plane (3)</span>
<span class="sd">        selection_hit_duts = [0, 1, 2, 4, 5, 6, 7]</span>
<span class="sd">    selection_track_quality : uint or iterable or iterable of iterable</span>
<span class="sd">        Track quality for each hit DUT.</span>
<span class="sd">    initial_rotation : array</span>
<span class="sd">        Initial rotation array.</span>
<span class="sd">    initial_translation : array</span>
<span class="sd">        Initial translation array.</span>
<span class="sd">    max_iterations : uint</span>
<span class="sd">        Maximum number of iterations of calc residuals, apply rotation refit loop until constant result is expected.</span>
<span class="sd">        Usually the procedure converges rather fast (&lt; 5 iterations)</span>
<span class="sd">    use_n_tracks: uint</span>
<span class="sd">        Defines the amount of tracks to be used for the alignment. More tracks can potentially make the result</span>
<span class="sd">        more precise, but will also increase the calculation time.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If True, create additional output plots.</span>
<span class="sd">    chunk_size : uint</span>
<span class="sd">        Chunk size of the data when reading from file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=== Aligning DUTs ===&#39;</span><span class="p">)</span>

    <span class="c1"># Open the pre-alignment and create empty alignment info (at the beginning only the z position is set)</span>
    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">input_alignment_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>  <span class="c1"># Open file with alignment data</span>
        <span class="n">prealignment</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">PreAlignment</span><span class="p">[:]</span>
        <span class="n">n_duts</span> <span class="o">=</span> <span class="n">prealignment</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">alignment_parameters</span> <span class="o">=</span> <span class="n">_create_alignment_array</span><span class="p">(</span><span class="n">n_duts</span><span class="p">)</span>
        <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;translation_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prealignment</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">initial_rotation</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">):</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">):</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_rotation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">initial_translation</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">):</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;translation_x&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_translation</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;translation_y&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_translation</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">):</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;translation_x&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_translation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;translation_y&#39;</span><span class="p">][</span><span class="n">dut_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alignment_parameters</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;A rotation angle &gt; pi / 4 is not supported, you should set the correct angle and translation as a start parameter, sorry!&#39;</span><span class="p">)</span>

    <span class="n">geometry_utils</span><span class="o">.</span><span class="n">store_alignment_parameters</span><span class="p">(</span>
        <span class="n">input_alignment_file</span><span class="p">,</span>
        <span class="n">alignment_parameters</span><span class="o">=</span><span class="n">alignment_parameters</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;absolute&#39;</span><span class="p">)</span>

    <span class="c1"># Create list with combinations of DUTs to align</span>
    <span class="k">if</span> <span class="n">align_duts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If None: align all DUTs</span>
        <span class="n">align_duts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">)</span>
    <span class="c1"># Check for value errors</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">align_duts</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;align_duts is no iterable&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">align_duts</span><span class="p">:</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;align_duts has no items&quot;</span><span class="p">)</span>
    <span class="c1"># Check if only non-iterable in iterable</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">align_duts</span><span class="p">)):</span>
        <span class="n">align_duts</span> <span class="o">=</span> <span class="p">[</span><span class="n">align_duts</span><span class="p">]</span>
    <span class="c1"># Check if only iterable in iterable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">align_duts</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;not all items in align_duts are iterable&quot;</span><span class="p">)</span>
    <span class="c1"># Finally check length of all iterables in iterable</span>
    <span class="k">for</span> <span class="n">dut</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dut</span><span class="p">:</span>  <span class="c1"># check the length of the items</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item in align_duts has length 0&quot;</span><span class="p">)</span>

    <span class="c1"># Check if some DUTs will not be aligned</span>
    <span class="n">all_align_duts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">duts</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">:</span>
        <span class="n">all_align_duts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">duts</span><span class="p">)</span>
    <span class="n">no_align_duts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_align_duts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">no_align_duts</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;These DUTs will not be aligned: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">align_dut</span><span class="p">)</span> <span class="k">for</span> <span class="n">align_dut</span> <span class="ow">in</span> <span class="n">no_align_duts</span><span class="p">))</span>

    <span class="c1"># Create track, hit selection</span>
    <span class="k">if</span> <span class="n">selection_hit_duts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If None: use all DUTs</span>
        <span class="n">selection_hit_duts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># copy each item</span>
        <span class="k">for</span> <span class="n">duts</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">:</span>
            <span class="n">selection_hit_duts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duts</span><span class="p">[:])</span>  <span class="c1"># require a hit for each fit DUT</span>
    <span class="c1"># Check iterable and length</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_hit_duts is no iterable&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">selection_hit_duts</span><span class="p">:</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_hit_duts has no items&quot;</span><span class="p">)</span>
    <span class="c1"># Check if only non-iterable in iterable</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_hit_duts</span><span class="p">)):</span>
        <span class="n">selection_hit_duts</span> <span class="o">=</span> <span class="p">[</span><span class="n">selection_hit_duts</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">]</span>
    <span class="c1"># Check if only iterable in iterable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_hit_duts</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;not all items in selection_hit_duts are iterable&quot;</span><span class="p">)</span>
    <span class="c1"># Finally check length of all arrays</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">align_duts</span><span class="p">):</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_hit_duts has the wrong length&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hit_dut</span> <span class="ow">in</span> <span class="n">selection_hit_duts</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hit_dut</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># check the length of the items</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item in selection_hit_duts has length &lt; 2&quot;</span><span class="p">)</span>

    <span class="c1"># Create track, hit selection</span>
    <span class="k">if</span> <span class="n">selection_fit_duts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If None: use all DUTs</span>
        <span class="n">selection_fit_duts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># copy each item</span>
        <span class="k">for</span> <span class="n">hit_duts</span> <span class="ow">in</span> <span class="n">selection_hit_duts</span><span class="p">:</span>
            <span class="n">selection_fit_duts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit_duts</span><span class="p">[:])</span>  <span class="c1"># require a hit for each fit DUT</span>
    <span class="c1"># Check iterable and length</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection_fit_duts</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_fit_duts is no iterable&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">selection_fit_duts</span><span class="p">:</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_fit_duts has no items&quot;</span><span class="p">)</span>
    <span class="c1"># Check if only non-iterable in iterable</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_fit_duts</span><span class="p">)):</span>
        <span class="n">selection_fit_duts</span> <span class="o">=</span> <span class="p">[</span><span class="n">selection_fit_duts</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">]</span>
    <span class="c1"># Check if only iterable in iterable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_fit_duts</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;not all items in selection_fit_duts are iterable&quot;</span><span class="p">)</span>
    <span class="c1"># Finally check length of all arrays</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection_fit_duts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">align_duts</span><span class="p">):</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_fit_duts has the wrong length&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fit_dut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_fit_duts</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_dut</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># check the length of the items</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item in selection_fit_duts has length &lt; 2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">fit_dut</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">[</span><span class="n">index</span><span class="p">]):</span>  <span class="c1"># fit DUTs are required to have a hit</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DUT in selection_fit_duts is not in selection_hit_duts&quot;</span><span class="p">)</span>

    <span class="c1"># Create track, hit selection</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection_track_quality</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>  <span class="c1"># all items the same, special case for selection_track_quality</span>
        <span class="n">selection_track_quality</span> <span class="o">=</span> <span class="p">[[</span><span class="n">selection_track_quality</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hit_duts</span><span class="p">)</span> <span class="k">for</span> <span class="n">hit_duts</span> <span class="ow">in</span> <span class="n">selection_hit_duts</span><span class="p">]</span>  <span class="c1"># every hit DUTs require a track quality value</span>
    <span class="c1"># Check iterable and length</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection_track_quality</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_track_quality is no iterable&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">selection_track_quality</span><span class="p">:</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_track_quality has no items&quot;</span><span class="p">)</span>
    <span class="c1"># Check if only non-iterable in iterable</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_track_quality</span><span class="p">)):</span>
        <span class="n">selection_track_quality</span> <span class="o">=</span> <span class="p">[</span><span class="n">selection_track_quality</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">align_duts</span><span class="p">]</span>
    <span class="c1"># Check if only iterable in iterable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">),</span> <span class="n">selection_track_quality</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;not all items in selection_track_quality are iterable&quot;</span><span class="p">)</span>
    <span class="c1"># Finally check length of all arrays</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection_track_quality</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">align_duts</span><span class="p">):</span>  <span class="c1"># empty iterable</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;selection_track_quality has the wrong length&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">track_quality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_track_quality</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">track_quality</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">[</span><span class="n">index</span><span class="p">]):</span>  <span class="c1"># check the length of each items</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;item in selection_track_quality and selection_hit_duts does not have the same length&quot;</span><span class="p">)</span>

    <span class="c1"># Loop over all combinations of DUTs to align, simplest case: use all DUTs at once to align</span>
    <span class="c1"># Usual case: align high resolution devices first, then other devices</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">actual_align_duts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">align_duts</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aligning DUTs: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dut</span><span class="p">)</span> <span class="k">for</span> <span class="n">dut</span> <span class="ow">in</span> <span class="n">actual_align_duts</span><span class="p">))</span>

        <span class="n">_duts_alignment</span><span class="p">(</span>
            <span class="n">track_candidates_file</span><span class="o">=</span><span class="n">input_track_candidates_file</span><span class="p">,</span>
            <span class="n">alignment_file</span><span class="o">=</span><span class="n">input_alignment_file</span><span class="p">,</span>
            <span class="n">alignment_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
            <span class="n">align_duts</span><span class="o">=</span><span class="n">actual_align_duts</span><span class="p">,</span>
            <span class="n">selection_fit_duts</span><span class="o">=</span><span class="n">selection_fit_duts</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">selection_hit_duts</span><span class="o">=</span><span class="n">selection_hit_duts</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">selection_track_quality</span><span class="o">=</span><span class="n">selection_track_quality</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">n_pixels</span><span class="o">=</span><span class="n">n_pixels</span><span class="p">,</span>
            <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
            <span class="n">use_n_tracks</span><span class="o">=</span><span class="n">use_n_tracks</span><span class="p">,</span>
            <span class="n">n_duts</span><span class="o">=</span><span class="n">n_duts</span><span class="p">,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Alignment finished successfully!&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_duts_alignment</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">,</span> <span class="n">alignment_file</span><span class="p">,</span> <span class="n">alignment_index</span><span class="p">,</span> <span class="n">align_duts</span><span class="p">,</span> <span class="n">selection_fit_duts</span><span class="p">,</span> <span class="n">selection_hit_duts</span><span class="p">,</span> <span class="n">selection_track_quality</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">use_n_tracks</span><span class="p">,</span> <span class="n">n_duts</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>  <span class="c1"># Called for each list of DUTs to align</span>
    <span class="c1"># Step 0: Reduce the number of tracks to increase the calculation time</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 0: Reduce number of tracks to </span><span class="si">%d</span><span class="s1"> =&#39;</span><span class="p">,</span> <span class="n">use_n_tracks</span><span class="p">)</span>
    <span class="n">track_quality_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">dut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">quality</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">quality</span> <span class="o">&lt;=</span> <span class="n">selection_track_quality</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="n">track_quality_mask</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dut</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">quality</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use track with hits in DUTs </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">selection_hit_duts</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data_selection</span><span class="o">.</span><span class="n">select_hits</span><span class="p">(</span><span class="n">hit_file</span><span class="o">=</span><span class="n">track_candidates_file</span><span class="p">,</span>
                               <span class="n">output_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_reduced_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                               <span class="n">max_hits</span><span class="o">=</span><span class="n">use_n_tracks</span><span class="p">,</span>
                               <span class="n">track_quality</span><span class="o">=</span><span class="n">track_quality_mask</span><span class="p">,</span>
                               <span class="n">track_quality_mask</span><span class="o">=</span><span class="n">track_quality_mask</span><span class="p">,</span>
                               <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="n">track_candidates_reduced</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_reduced_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span>

    <span class="c1"># Step 1: Take the found tracks and revert the pre-alignment to start alignment from the beginning</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 1: Revert pre-alignment =&#39;</span><span class="p">)</span>
    <span class="n">apply_alignment</span><span class="p">(</span><span class="n">input_hit_file</span><span class="o">=</span><span class="n">track_candidates_reduced</span><span class="p">,</span>
                    <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>  <span class="c1"># Revert prealignent</span>
                    <span class="n">output_hit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_reduced</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_not_aligned.h5&#39;</span><span class="p">,</span>
                    <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">force_prealignment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="c1"># Stage N: Repeat alignment with constrained residuals until total residual does not decrease anymore</span>
    <span class="n">_calculate_translation_alignment</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_reduced</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_not_aligned.h5&#39;</span><span class="p">,</span>
                                     <span class="n">alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                                     <span class="n">fit_duts</span><span class="o">=</span><span class="n">align_duts</span><span class="p">,</span>
                                     <span class="n">selection_fit_duts</span><span class="o">=</span><span class="n">selection_fit_duts</span><span class="p">,</span>
                                     <span class="n">selection_hit_duts</span><span class="o">=</span><span class="n">selection_hit_duts</span><span class="p">,</span>
                                     <span class="n">selection_track_quality</span><span class="o">=</span><span class="n">selection_track_quality</span><span class="p">,</span>
                                     <span class="n">n_pixels</span><span class="o">=</span><span class="n">n_pixels</span><span class="p">,</span>
                                     <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                                     <span class="n">n_duts</span><span class="o">=</span><span class="n">n_duts</span><span class="p">,</span>
                                     <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
                                     <span class="n">plot_title_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                     <span class="n">output_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="c1"># Plot final result</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 7: Plot final result =&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)),</span> <span class="s1">&#39;Alignment_</span><span class="si">%d</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">))</span> <span class="k">as</span> <span class="n">output_pdf</span><span class="p">:</span>
            <span class="c1"># Apply final alignment result</span>
            <span class="n">apply_alignment</span><span class="p">(</span><span class="n">input_hit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_reduced</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_not_aligned.h5&#39;</span><span class="p">,</span>
                            <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                            <span class="n">output_hit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_final_tmp_</span><span class="si">%s</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="n">fit_tracks</span><span class="p">(</span><span class="n">input_track_candidates_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                       <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                       <span class="n">output_tracks_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                       <span class="n">fit_duts</span><span class="o">=</span><span class="n">align_duts</span><span class="p">,</span>  <span class="c1"># Only create residuals of selected DUTs</span>
                       <span class="n">selection_fit_duts</span><span class="o">=</span><span class="n">selection_fit_duts</span><span class="p">,</span>  <span class="c1"># Only use selected duts</span>
                       <span class="n">selection_hit_duts</span><span class="o">=</span><span class="n">selection_hit_duts</span><span class="p">,</span>
                       <span class="n">exclude_dut_hit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># For unconstrained residuals</span>
                       <span class="n">selection_track_quality</span><span class="o">=</span><span class="n">selection_track_quality</span><span class="p">,</span>
                       <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="n">calculate_residuals</span><span class="p">(</span><span class="n">input_tracks_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                                <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                                <span class="n">output_residuals_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_residuals_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">,</span>
                                <span class="n">n_pixels</span><span class="o">=</span><span class="n">n_pixels</span><span class="p">,</span>
                                <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                                <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
                                <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_final_tmp_</span><span class="si">%d</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_residuals_final_tmp_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_reduced</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_not_aligned.h5&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_reduced_</span><span class="si">%d</span><span class="s1">.h5&#39;</span> <span class="o">%</span> <span class="n">alignment_index</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_calculate_translation_alignment</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">,</span> <span class="n">alignment_file</span><span class="p">,</span> <span class="n">fit_duts</span><span class="p">,</span> <span class="n">selection_fit_duts</span><span class="p">,</span> <span class="n">selection_hit_duts</span><span class="p">,</span> <span class="n">selection_track_quality</span><span class="p">,</span> <span class="n">n_pixels</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">n_duts</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="n">plot_title_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Main function that fits tracks, calculates the residuals, deduces rotation and translation values from the residuals</span>
<span class="sd">    and applies the new alignment to the track hits. The alignment result is scored as a combined</span>
<span class="sd">    residual value of all planes that are being aligned in x and y weighted by the pixel pitch in x and y. &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">alignment_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>  <span class="c1"># Open file with alignment data</span>
        <span class="n">alignment_last_iteration</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Alignment</span><span class="p">[:]</span>

    <span class="n">total_residual</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Did not converge to good solution in </span><span class="si">%d</span><span class="s1"> iterations. Increase max_iterations&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>

        <span class="n">apply_alignment</span><span class="p">(</span><span class="n">input_hit_file</span><span class="o">=</span><span class="n">track_candidates_file</span><span class="p">,</span>  <span class="c1"># Always apply alignment to starting file</span>
                        <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                        <span class="n">output_hit_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_no_align_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                        <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">force_prealignment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Step 2: Fit tracks for all DUTs</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 2 / iteration </span><span class="si">%d</span><span class="s1">: Fit tracks for all DUTs =&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">fit_tracks</span><span class="p">(</span><span class="n">input_track_candidates_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_no_align_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                   <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                   <span class="n">output_tracks_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                   <span class="n">fit_duts</span><span class="o">=</span><span class="n">fit_duts</span><span class="p">,</span>  <span class="c1"># Only create residuals of selected DUTs</span>
                   <span class="n">selection_fit_duts</span><span class="o">=</span><span class="n">selection_fit_duts</span><span class="p">,</span>   <span class="c1"># Only use selected DUTs for track fit</span>
                   <span class="n">selection_hit_duts</span><span class="o">=</span><span class="n">selection_hit_duts</span><span class="p">,</span>  <span class="c1"># Only use selected duts</span>
                   <span class="n">exclude_dut_hit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># For constrained residuals</span>
                   <span class="n">selection_track_quality</span><span class="o">=</span><span class="n">selection_track_quality</span><span class="p">,</span>
                   <span class="n">force_prealignment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Step 3: Calculate the residuals for each DUT</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 3 / iteration </span><span class="si">%d</span><span class="s1">: Calculate the residuals for each selected DUT =&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">calculate_residuals</span><span class="p">(</span><span class="n">input_tracks_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                            <span class="n">input_alignment_file</span><span class="o">=</span><span class="n">alignment_file</span><span class="p">,</span>
                            <span class="n">output_residuals_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_residuals_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                            <span class="n">n_pixels</span><span class="o">=</span><span class="n">n_pixels</span><span class="p">,</span>
                            <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                            <span class="c1"># smaller devices needs None, otherwise npixels_per_bin=5 and nbins_per_pixel=1 might improve the first step</span>
                            <span class="n">npixels_per_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">nbins_per_pixel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Step 4: Deduce rotations from the residuals</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 4 / iteration </span><span class="si">%d</span><span class="s1">: Deduce rotations and translations from the residuals =&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">alignment_parameters_change</span><span class="p">,</span> <span class="n">new_total_residual</span> <span class="o">=</span> <span class="n">_analyze_residuals</span><span class="p">(</span><span class="n">residuals_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_residuals_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">,</span>
                                                                             <span class="n">fit_duts</span><span class="o">=</span><span class="n">fit_duts</span><span class="p">,</span>
                                                                             <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                                                                             <span class="n">n_duts</span><span class="o">=</span><span class="n">n_duts</span><span class="p">,</span>
                                                                             <span class="n">translation_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                             <span class="n">plot_title_prefix</span><span class="o">=</span><span class="n">plot_title_prefix</span><span class="p">,</span>
                                                                             <span class="n">relaxation_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># FIXME: good code practice: nothing hardcoded</span>
                                                                             <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>

        <span class="c1"># Create actual alignment (old alignment + the actual relative change)</span>
        <span class="n">new_alignment_parameters</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">merge_alignment_parameters</span><span class="p">(</span>
            <span class="n">alignment_last_iteration</span><span class="p">,</span>
            <span class="n">alignment_parameters_change</span><span class="p">,</span>
            <span class="n">select_duts</span><span class="o">=</span><span class="n">fit_duts</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;relative&#39;</span><span class="p">)</span>

        <span class="c1"># FIXME: This step does not work well</span>
<span class="c1">#         # Step 5: Try to find better rotation by minimizing the residual in x + y for different angles</span>
<span class="c1">#         logging.info(&#39;= Alignment step 5 / iteration %d: Optimize alignment by minimizing residuals =&#39;, iteration)</span>
<span class="c1">#         new_alignment_parameters, new_total_residual = _optimize_alignment(tracks_file=os.path.splitext(track_candidates_file)[0] + &#39;_tracks_%d_tmp.h5&#39; % iteration,</span>
<span class="c1">#                                                                            alignment_last_iteration=alignment_last_iteration,</span>
<span class="c1">#                                                                            new_alignment_parameters=new_alignment_parameters,</span>
<span class="c1">#                                                                            pixel_size=pixel_size)</span>

        <span class="c1"># Delete not needed files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_no_align_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_tracks_</span><span class="si">%d</span><span class="s1">_tmp.pdf&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">track_candidates_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_residuals_</span><span class="si">%d</span><span class="s1">_tmp.h5&#39;</span> <span class="o">%</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total residual </span><span class="si">%1.4e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new_total_residual</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_residual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">new_total_residual</span> <span class="o">&gt;</span> <span class="n">total_residual</span><span class="p">:</span>  <span class="c1"># True if actual alignment is worse than the alignment from last iteration</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;!! Best alignment found !!&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 6 / iteration </span><span class="si">%d</span><span class="s1">: Use rotation / translation information from previous iteration =&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
            <span class="n">geometry_utils</span><span class="o">.</span><span class="n">store_alignment_parameters</span><span class="p">(</span><span class="n">alignment_file</span><span class="p">,</span>  <span class="c1"># Store alignment from last iteration</span>
                                                      <span class="n">alignment_last_iteration</span><span class="p">,</span>
                                                      <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
                                                      <span class="n">select_duts</span><span class="o">=</span><span class="n">fit_duts</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_residual</span> <span class="o">=</span> <span class="n">new_total_residual</span>

        <span class="n">alignment_last_iteration</span> <span class="o">=</span> <span class="n">new_alignment_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># in_file_h5.root.Alignment[:]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;= Alignment step 6 / iteration </span><span class="si">%d</span><span class="s1">: Set new rotation / translation information in alignment file =&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
        <span class="n">geometry_utils</span><span class="o">.</span><span class="n">store_alignment_parameters</span><span class="p">(</span><span class="n">alignment_file</span><span class="p">,</span>
                                                  <span class="n">new_alignment_parameters</span><span class="p">,</span>
                                                  <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span>
                                                  <span class="n">select_duts</span><span class="o">=</span><span class="n">fit_duts</span><span class="p">)</span>




<span class="c1"># Helper functions for the alignment. Not to be used directly.</span>
<span class="k">def</span> <span class="nf">_create_alignment_array</span><span class="p">(</span><span class="n">n_duts</span><span class="p">):</span>
    <span class="c1"># Result Translation / rotation table</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;DUT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)]</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;translation_x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;translation_y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;translation_z&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;correlation_x&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
    <span class="n">description</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;correlation_y&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_duts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
    <span class="n">array</span><span class="p">[:][</span><span class="s1">&#39;DUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_duts</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">array</span>


<span class="k">def</span> <span class="nf">_analyze_residuals</span><span class="p">(</span><span class="n">residuals_file</span><span class="p">,</span> <span class="n">fit_duts</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">n_duts</span><span class="p">,</span> <span class="n">translation_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relaxation_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">plot_title_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Take the residual plots and deduce rotation and translation angles from them &#39;&#39;&#39;</span>
    <span class="n">alignment_parameters</span> <span class="o">=</span> <span class="n">_create_alignment_array</span><span class="p">(</span><span class="n">n_duts</span><span class="p">)</span>

    <span class="n">total_residual</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Sum of all residuals to judge the overall alignment</span>

    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">residuals_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dut_index</span> <span class="ow">in</span> <span class="n">fit_duts</span><span class="p">:</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;DUT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dut_index</span>
            <span class="c1"># Global residuals</span>
            <span class="n">hist_node</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/ResidualsX_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">)</span>
            <span class="n">std_x</span> <span class="o">=</span> <span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Add resdidual to total residual normalized to pixel pitch in x</span>
            <span class="n">total_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">total_residual</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">std_x</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">output_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="n">histogram</span><span class="o">=</span><span class="n">hist_node</span><span class="p">[:],</span>
                                          <span class="n">edges</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">xedges</span><span class="p">,</span>
                                          <span class="n">fit</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_coeff</span><span class="p">,</span>
                                          <span class="n">fit_errors</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_cov</span><span class="p">,</span>
                                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Residuals for DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span>
                                          <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;X residual [um]&#39;</span><span class="p">,</span>
                                          <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>

            <span class="n">hist_node</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/ResidualsY_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">)</span>
            <span class="n">std_y</span> <span class="o">=</span> <span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Add resdidual to total residual normalized to pixel pitch in y</span>
            <span class="n">total_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">total_residual</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">std_y</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">translation_only</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">alignment_parameters</span><span class="p">,</span> <span class="n">total_residual</span>

            <span class="k">if</span> <span class="n">output_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span><span class="n">histogram</span><span class="o">=</span><span class="n">hist_node</span><span class="p">[:],</span>
                                          <span class="n">edges</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">xedges</span><span class="p">,</span>
                                          <span class="n">fit</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_coeff</span><span class="p">,</span>
                                          <span class="n">fit_errors</span><span class="o">=</span><span class="n">hist_node</span><span class="o">.</span><span class="n">_v_attrs</span><span class="o">.</span><span class="n">fit_cov</span><span class="p">,</span>
                                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Residuals for DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span>
                                          <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;Y residual [um]&#39;</span><span class="p">,</span>
                                          <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">)</span>

            <span class="c1"># use offset at origin of sensor (center of sensor) to calculate x and y correction</span>
            <span class="c1"># do not use mean/median of 1D residual since it depends on the beam spot position when the device is rotated</span>
            <span class="n">mu_x</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/YResidualsX_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mu_y</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/XResidualsY_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># use slope to calculate alpha, beta and gamma</span>
            <span class="n">m_xx</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/XResidualsX_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">m_yy</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/YResidualsY_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">m_xy</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/XResidualsY_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">m_yx</span> <span class="o">=</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">get_node_attr</span><span class="p">(</span><span class="s1">&#39;/YResidualsX_DUT</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dut_index</span><span class="p">,</span> <span class="s1">&#39;fit_coeff&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">get_rotation_from_residual_fit</span><span class="p">(</span><span class="n">m_xx</span><span class="o">=</span><span class="n">m_xx</span><span class="p">,</span> <span class="n">m_xy</span><span class="o">=</span><span class="n">m_xy</span><span class="p">,</span> <span class="n">m_yx</span><span class="o">=</span><span class="n">m_yx</span><span class="p">,</span> <span class="n">m_yy</span><span class="o">=</span><span class="n">m_yy</span><span class="p">)</span>

            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;correlation_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_x</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;translation_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu_x</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;correlation_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_y</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;translation_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu_y</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">relaxation_factor</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">relaxation_factor</span>
            <span class="n">alignment_parameters</span><span class="p">[</span><span class="n">dut_index</span><span class="p">][</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">relaxation_factor</span>

    <span class="k">return</span> <span class="n">alignment_parameters</span><span class="p">,</span> <span class="n">total_residual</span>


<span class="k">def</span> <span class="nf">_optimize_alignment</span><span class="p">(</span><span class="n">tracks_file</span><span class="p">,</span> <span class="n">alignment_last_iteration</span><span class="p">,</span> <span class="n">new_alignment_parameters</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Changes the angles of a virtual plane such that the projected track intersections onto this virtual plane</span>
<span class="sd">    are most close to the measured hits on the real DUT at this position. Then the angles of the virtual plane</span>
<span class="sd">    should correspond to the real DUT angles. The distance is not weighted quadratically (RMS) but linearly since</span>
<span class="sd">    this leads to better results (most likely heavily scattered tracks / beam angle spread at the edges are weighted less).&#39;&#39;&#39;</span>
    <span class="c1"># Create new absolute alignment</span>
    <span class="n">alignment_result</span> <span class="o">=</span> <span class="n">new_alignment_parameters</span>

    <span class="k">def</span> <span class="nf">_minimize_me</span><span class="p">(</span><span class="n">align</span><span class="p">,</span> <span class="n">dut_position</span><span class="p">,</span> <span class="n">hit_x_local</span><span class="p">,</span> <span class="n">hit_y_local</span><span class="p">,</span> <span class="n">hit_z_local</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">slopes</span><span class="p">):</span>
        <span class="c1"># Calculate intersections with a dut plane given by alpha, beta, gamma at the dut_position in the global coordinate system</span>
        <span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                         <span class="n">beta</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                         <span class="n">gamma</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">basis_global</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">dut_plane_normal</span> <span class="o">=</span> <span class="n">basis_global</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">actual_dut_position</span> <span class="o">=</span> <span class="n">dut_position</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">actual_dut_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">align</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e6</span>  <span class="c1"># Convert z position from m to um</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">get_line_intersections_with_plane</span><span class="p">(</span><span class="n">line_origins</span><span class="o">=</span><span class="n">offsets</span><span class="p">,</span>
                                                                         <span class="n">line_directions</span><span class="o">=</span><span class="n">slopes</span><span class="p">,</span>
                                                                         <span class="n">position_plane</span><span class="o">=</span><span class="n">actual_dut_position</span><span class="p">,</span>
                                                                         <span class="n">normal_plane</span><span class="o">=</span><span class="n">dut_plane_normal</span><span class="p">)</span>

        <span class="c1"># Transform to the local coordinate system to compare with measured hits</span>
        <span class="n">transformation_matrix</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">global_to_local_transformation_matrix</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">actual_dut_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                     <span class="n">y</span><span class="o">=</span><span class="n">actual_dut_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                     <span class="n">z</span><span class="o">=</span><span class="n">actual_dut_position</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                                                     <span class="n">alpha</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                     <span class="n">beta</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                     <span class="n">gamma</span><span class="o">=</span><span class="n">align</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">intersection_x_local</span><span class="p">,</span> <span class="n">intersection_y_local</span><span class="p">,</span> <span class="n">intersection_z_local</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">apply_transformation_matrix</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">intersections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                                                                      <span class="n">y</span><span class="o">=</span><span class="n">intersections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                                                                                      <span class="n">z</span><span class="o">=</span><span class="n">intersections</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                                                                                                                      <span class="n">transformation_matrix</span><span class="o">=</span><span class="n">transformation_matrix</span><span class="p">)</span>

        <span class="c1"># Cross check if transformations are correct (z == 0 in the local coordinate system)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">hit_z_local</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">hit_z_local</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">intersection_z_local</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Hit z position = </span><span class="si">%s</span><span class="s1"> and z intersection </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">hit_z_local</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">hit_z_local</span><span class="p">,</span> <span class="mi">0</span><span class="p">)][:</span><span class="mi">3</span><span class="p">]),</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">intersection_z_local</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">intersection_z_local</span><span class="p">,</span> <span class="mi">0</span><span class="p">)][:</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The transformation to the local coordinate system did not give all z = 0. Wrong alignment used?&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hit_x_local</span> <span class="o">-</span> <span class="n">intersection_x_local</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hit_y_local</span> <span class="o">-</span> <span class="n">intersection_y_local</span><span class="p">))</span> <span class="o">/</span> <span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#         return np.sqrt(np.square(np.std(hit_x_local - intersection_x_local) / pixel_size[0]) + np.square(np.std(hit_y_local - intersection_y_local)) / pixel_size[1])</span>

    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">tracks_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file_h5</span><span class="p">:</span>
        <span class="n">residuals_before</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">residuals_after</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="n">actual_dut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">r&#39;\d+&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dut_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alignment_last_iteration</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;translation_x&#39;</span><span class="p">],</span> <span class="n">alignment_last_iteration</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;translation_y&#39;</span><span class="p">],</span> <span class="n">alignment_last_iteration</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;translation_z&#39;</span><span class="p">]])</span>

            <span class="c1"># Hits with the actual alignment</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;x_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">actual_dut</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;y_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">actual_dut</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;z_dut_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">actual_dut</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Transform hits to the local coordinate system</span>
            <span class="n">hit_x_local</span><span class="p">,</span> <span class="n">hit_y_local</span><span class="p">,</span> <span class="n">hit_z_local</span> <span class="o">=</span> <span class="n">geometry_utils</span><span class="o">.</span><span class="n">apply_alignment</span><span class="p">(</span><span class="n">hits_x</span><span class="o">=</span><span class="n">hits</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                                   <span class="n">hits_y</span><span class="o">=</span><span class="n">hits</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                                                   <span class="n">hits_z</span><span class="o">=</span><span class="n">hits</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                                                                                   <span class="n">dut_index</span><span class="o">=</span><span class="n">actual_dut</span><span class="p">,</span>
                                                                                   <span class="n">alignment</span><span class="o">=</span><span class="n">alignment_last_iteration</span><span class="p">,</span>
                                                                                   <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Track infos</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;offset_0&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;offset_1&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;offset_2&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;slope_0&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;slope_1&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[:][</span><span class="s1">&#39;slope_2&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Rotation start values of minimizer</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
            <span class="n">z_position</span> <span class="o">=</span> <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;translation_z&#39;</span><span class="p">]</span>

            <span class="c1"># Trick to have the same order of magnitue of variation for angles and position, otherwise scipy minimizers</span>
            <span class="c1"># do not converge if step size of parameters is very different</span>
            <span class="n">z_position_in_m</span> <span class="o">=</span> <span class="n">z_position</span> <span class="o">/</span> <span class="mi">1</span><span class="n">e6</span>

            <span class="n">residual</span> <span class="o">=</span> <span class="n">_minimize_me</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">z_position_in_m</span><span class="p">]),</span>
                                    <span class="n">dut_position</span><span class="p">,</span>
                                    <span class="n">hit_x_local</span><span class="p">,</span>
                                    <span class="n">hit_y_local</span><span class="p">,</span>
                                    <span class="n">hit_z_local</span><span class="p">,</span>
                                    <span class="n">pixel_size</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">],</span>
                                    <span class="n">offsets</span><span class="p">,</span>
                                    <span class="n">slopes</span><span class="p">)</span>
            <span class="n">residuals_before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Optimize angles / z of DUT</span><span class="si">%d</span><span class="s1"> with start parameters: </span><span class="si">%1.2e</span><span class="s1">, </span><span class="si">%1.2e</span><span class="s1">, </span><span class="si">%1.2e</span><span class="s1"> Rad and z = </span><span class="si">%d</span><span class="s1"> um with residual </span><span class="si">%1.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual_dut</span><span class="p">,</span>
                                                                                                                                             <span class="n">alpha</span><span class="p">,</span>
                                                                                                                                             <span class="n">beta</span><span class="p">,</span>
                                                                                                                                             <span class="n">gamma</span><span class="p">,</span>
                                                                                                                                             <span class="n">z_position_in_m</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e6</span><span class="p">,</span>
                                                                                                                                             <span class="n">residual</span><span class="p">))</span>

            <span class="c1"># FIXME:</span>
            <span class="c1"># Has to be heavily restricted otherwise converges to unphysical solutions since the scoring with residuals is not really working well</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">alpha</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">),</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">beta</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">),</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">),</span> <span class="p">(</span><span class="n">z_position_in_m</span> <span class="o">-</span> <span class="mi">10</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="n">z_position_in_m</span> <span class="o">+</span> <span class="mi">10</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)]</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">_minimize_me</span><span class="p">,</span>
                              <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">z_position_in_m</span><span class="p">]),</span>  <span class="c1"># Start values from residual fit</span>
                              <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">dut_position</span><span class="p">,</span> <span class="n">hit_x_local</span><span class="p">,</span> <span class="n">hit_y_local</span><span class="p">,</span> <span class="n">hit_z_local</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">],</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">slopes</span><span class="p">),</span>
                              <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                              <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">)</span>

            <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">z_position_in_m</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">_minimize_me</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">dut_position</span><span class="p">,</span>
                                    <span class="n">hit_x_local</span><span class="p">,</span>
                                    <span class="n">hit_y_local</span><span class="p">,</span>
                                    <span class="n">hit_z_local</span><span class="p">,</span>
                                    <span class="n">pixel_size</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">],</span>
                                    <span class="n">offsets</span><span class="p">,</span>
                                    <span class="n">slopes</span><span class="p">)</span>
            <span class="n">residuals_after</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found angles of DUT</span><span class="si">%d</span><span class="s1"> with best angles: </span><span class="si">%1.2e</span><span class="s1">, </span><span class="si">%1.2e</span><span class="s1">, </span><span class="si">%1.2e</span><span class="s1"> Rad and z = </span><span class="si">%d</span><span class="s1"> um with residual </span><span class="si">%1.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual_dut</span><span class="p">,</span>
                                                                                                                                 <span class="n">alpha</span><span class="p">,</span>
                                                                                                                                 <span class="n">beta</span><span class="p">,</span>
                                                                                                                                 <span class="n">gamma</span><span class="p">,</span>
                                                                                                                                 <span class="n">z_position_in_m</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e6</span><span class="p">,</span>
                                                                                                                                 <span class="n">residual</span><span class="p">))</span>
            <span class="c1"># Rotation start values of minimizer</span>
            <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span>
            <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span>
            <span class="n">alignment_result</span><span class="p">[</span><span class="n">actual_dut</span><span class="p">][</span><span class="s1">&#39;translation_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_position_in_m</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e6</span>  <span class="c1"># convert z position from m to um</span>

    <span class="n">total_residuals_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals_before</span><span class="p">))))</span>
    <span class="n">total_residuals_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals_after</span><span class="p">))))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reduced the total residuals in the optimization steps from </span><span class="si">%1.2e</span><span class="s1"> to </span><span class="si">%1.2e</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">total_residuals_before</span><span class="p">,</span> <span class="n">total_residuals_after</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_residuals_before</span> <span class="o">&lt;</span> <span class="n">total_residuals_after</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Alignment optimization did not converge!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alignment_result</span><span class="p">,</span> <span class="n">total_residuals_after</span>  <span class="c1"># Return alignment result and total residual</span>


<span class="c1"># Helper functions to be called from multiple processes</span>
<span class="k">def</span> <span class="nf">_correlate_cluster</span><span class="p">(</span><span class="n">cluster_dut_0</span><span class="p">,</span> <span class="n">cluster_file</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">start_event_number</span><span class="p">,</span> <span class="n">stop_event_number</span><span class="p">,</span> <span class="n">column_correlation</span><span class="p">,</span> <span class="n">row_correlation</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">cluster_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">actual_in_file_h5</span><span class="p">:</span>  <span class="c1"># Open other DUT cluster file</span>
        <span class="k">for</span> <span class="n">actual_dut_cluster</span><span class="p">,</span> <span class="n">start_index</span> <span class="ow">in</span> <span class="n">analysis_utils</span><span class="o">.</span><span class="n">data_aligned_at_events</span><span class="p">(</span><span class="n">actual_in_file_h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">Cluster</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="n">start_index</span><span class="p">,</span> <span class="n">start_event_number</span><span class="o">=</span><span class="n">start_event_number</span><span class="p">,</span> <span class="n">stop_event_number</span><span class="o">=</span><span class="n">stop_event_number</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">fail_on_missing_events</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># Loop over the cluster in the actual cluster file in chunks</span>

            <span class="n">analysis_utils</span><span class="o">.</span><span class="n">correlate_cluster_on_event_number</span><span class="p">(</span><span class="n">data_1</span><span class="o">=</span><span class="n">cluster_dut_0</span><span class="p">,</span>
                                                             <span class="n">data_2</span><span class="o">=</span><span class="n">actual_dut_cluster</span><span class="p">,</span>
                                                             <span class="n">column_corr_hist</span><span class="o">=</span><span class="n">column_correlation</span><span class="p">,</span>
                                                             <span class="n">row_corr_hist</span><span class="o">=</span><span class="n">row_correlation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">column_correlation</span><span class="p">,</span> <span class="n">row_correlation</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David-Leon Pohl.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: development
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../0.0.1/index.html">0.0.1</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../development/_modules/testbeam_analysis/dut_alignment.html">development</a></dd>
            <dd><a href="../../master/index.html">master</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>